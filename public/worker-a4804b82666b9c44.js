(()=>{"use strict";let e;function t(e){return new Promise((t,o)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>o(e.error)})}function o(){var o;let n;return e||(o="keyval",e=(e,r)=>(()=>{if(n)return n;let e=indexedDB.open("keyval-store");return e.onupgradeneeded=()=>e.result.createObjectStore(o),(n=t(e)).then(e=>{e.onclose=()=>n=void 0},()=>{}),n})().then(t=>r(t.transaction(o,e).objectStore(o)))),e}function n(e,r=o()){return r("readonly",o=>t(o.get(e)))}let r="zik_lodge_outbox";async function i(){let e=await n(r);if(e&&0!==e.length)for(let i of(console.log("SW: Syncing outbox...",e.length,"items"),e)){if(i.files&&Object.keys(i.files).length>0){console.log("SW: Skipping item ".concat(i.id," (requires file upload - waiting for foreground)"));continue}try{if((await fetch("/api/lodges/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(i.authToken)},body:JSON.stringify({lodgeData:i.formData,units:i.units})})).ok){let e=(await n(r)||[]).filter(e=>e.id!==i.id);await function(e,n,r=o()){return r("readwrite",o=>(o.put(n,e),t(o.transaction)))}(r,e),(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:"SYNC_SUCCESS",id:i.id})})}}catch(e){throw console.error("SW: Sync failed for item:",i.id,e),e}}}self.addEventListener("sync",e=>{"zik-sync-lodges"===e.tag&&e.waitUntil(i())})})();